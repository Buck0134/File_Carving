<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Forensics Tool</title>
    <!-- Code retrieved from https://getbootstrap.com/docs/5.3/getting-started/introduction/ for using Bootstrap, on April 7th 2024 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            text-align: center;
            font-family: 'Courier New', Courier, monospace;
        }
        h2 {
            padding-top: 30px;
            padding-bottom: 50px;
            font-weight: bold;
        }
        #mmlsData-meta {
            white-space: pre; /* Code referenced from https://www.w3schools.com/cssref/pr_text_white-space.php for wrapping text based on whitespances, on April 7th 2024 */
        }
        button {
            border-radius: 10px;
            height: 30px;
            width: 200px;
            font-family: 'Courier New', Courier, monospace;
            background-color: rgb(51, 62, 116);
            border: 0px;
            color: white;
        }
        table input{
            font-family: 'Courier New', Courier, monospace;
            height: 20px;
            width: 20px;
            justify-content: center;
        }
        #filePath{
            font-family: 'Courier New', Courier, monospace;
            height: 30px;
            width: 300px;
        }
        
        .hash-button-container{
            padding-top: 30px;
            display: inline-block /* Code retrived from https://www.shecodes.io/athena/1837-how-to-put-2-images-on-one-line-with-css for putting 2 elements in one line, on April 7th 2024*/
        }
        .button-container{
            display: flex;
            justify-content: center;
            padding-top: 30px;
        }
        .carve-button-container{
            padding-top: 40px;
            display: flex;
            justify-content: center;

            #combinedCarvingBtn {
                margin-left: 20px;
                margin-right: 20px;
            }
            #individualCarvingBtn {
                margin-left: 20px;
                margin-right: 20px;
            }
        }
        #md5Display{
            padding-top: 20px;
            padding-bottom: 30px;
        }
        #mmlsData-meta{
            text-align: left;
        }
    </style>
    
</head>
<body>
    <h2>Forensics File Carving Tool</h2>
    <!-- Code adapted from https://getbootstrap.com/docs/5.3/layout/columns/ for utilizing columns to create a side bar in Bootstrap, on April 7th 2024 -->
    <div class="row"> 
        <div class="col-3">
            <form id="filePathForm">
                <label for="filePath">Enter the file path:</label>
                <input type="text" id="filePath" name="filePath">
                <div class="hash-button-container">
                    <button type="submit" class="hash-button">Check MD5 Hash</button>
                </div>
            </form>
            <p id="md5Display"></p>
            <div class="button-container">
                <button id="fetchMmlsBtn" style="display:none;">Get Partition Table</button>
            </div>
        </div>
        <div class="col-8">
            <p id="partitionTable-title"></p>
            <p id="mmlsData-meta"></p>
            <!-- Code adapted from https://getbootstrap.com/docs/4.0/content/tables/ for formatting the table through Bootstrap, on April 7th 2024 -->
            <table id="mmlsData-table" class="table table-striped table-bordered"></table>
            <div class="carve-button-container">
                <button id="combinedCarvingBtn" style="display:none;">Carve Together</button>
                <button id="individualCarvingBtn" style="display:none;">Carve Individually</button>
            </div>
            <span id="errors"></span>
        </div>
    </div>
    

    <script>
        let filePath = ''; // This will hold the file path state
        var partitions = null; // Stores the partition information

        document.getElementById('filePathForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the form from submitting the traditional way
            filePath = document.getElementById('filePath').value; // Update the filePath state
            
            // Fetch the MD5 checksum
            fetch(`/api/file-md5?file_path=${encodeURIComponent(filePath)}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('md5Display').textContent = `MD5 Hash: ${data.md5}`;
                    document.getElementById('fetchMmlsBtn').style.display = 'block'; // Show the MMLS button
                })
                .catch(error => console.error('Error fetching MD5 data:', error));
        });

        document.getElementById('fetchMmlsBtn').addEventListener('click', function() {
            // Fetch the MMLS info using the saved filePath state
            fetch(`/api/mmls-info?file_path=${encodeURIComponent(filePath)}`)
                .then(response => response.json())
                .then(data => {
                    // Ensure the presence of partition table information in the response
                    if ('metadata' in data) {
                        document.getElementById('mmlsData-meta').textContent = `${data.metadata}`;
                        document.getElementById('partitionTable-title').textContent = "Partition Table";
                        partitions = data.sectors_info;

                        const table = document.getElementById('mmlsData-table');

                        // Code adapted from https://stackoverflow.com/questions/7271490/delete-all-rows-in-an-html-table for removing rows in a table, on April 7th 2024
                        table.innerHTML = ""; // Clear the current rows in the table so that only new generated contents are displayed

                        // Code adapted from https://www.w3schools.com/js/js_htmldom_nodes.asp for appending children to an HTML element, on April 7th 2024
                        // Table Head
                        const title_thead = document.createElement("thead");
                        // A table row for headers
                        const title_tr = document.createElement("tr");
                        // Create the table headers
                        const th_checkbox = document.createElement("th");
                        const th_index = document.createElement("th");
                        const th_slot = document.createElement("th");
                        const th_start = document.createElement("th");
                        const th_end = document.createElement("th");
                        const th_length = document.createElement("th");
                        const th_description = document.createElement("th");
                        // Header contents
                        const title_checkbox = document.createTextNode("");
                        const title_index = document.createTextNode("Index");
                        const title_slot = document.createTextNode("Slot");
                        const title_start = document.createTextNode("Start");
                        const title_end = document.createTextNode("End");
                        const title_length = document.createTextNode("Length");
                        const title_description = document.createTextNode("Description");

                        th_checkbox.appendChild(title_checkbox);
                        th_index.appendChild(title_index);
                        th_slot.appendChild(title_slot);
                        th_start.appendChild(title_start);
                        th_end.appendChild(title_end);
                        th_length.appendChild(title_length);
                        th_description.appendChild(title_description);

                        title_tr.appendChild(th_checkbox);
                        title_tr.appendChild(th_index);
                        title_tr.appendChild(th_slot);
                        title_tr.appendChild(th_start);
                        title_tr.appendChild(th_end);
                        title_tr.appendChild(th_length);
                        title_tr.appendChild(th_description);

                        // Append the row to table header and append the table header to the table
                        title_thead.appendChild(title_tr)
                        table.appendChild(title_thead)

                        // Table Body
                        const tbody = document.createElement("tbody");
                        // Iteratively add elements to the mmlsData-table
                        data.sectors_info.forEach(element => {
                            // Table elements
                            const tr = document.createElement("tr"); // A table row for this table entry
                            const td_checkbox = document.createElement("td")
                            const td_index = document.createElement("td");
                            const td_slot = document.createElement("td");
                            const td_start = document.createElement("td");
                            const td_end = document.createElement("td");
                            const td_length = document.createElement("td");
                            const td_description = document.createElement("td");
                            // Get contents from data
                            // Code adpated from https://stackoverflow.com/questions/866239/creating-the-checkbox-dynamically-using-javascript for dynamically creating checkboxes, on April 7th 2024
                            const checkbox_element = document.createElement("input")
                            checkbox_element.type = "checkbox"
                            checkbox_element.class = "checkbox"
                            checkbox_element.name = "checkboxes"
                            const index = document.createTextNode(element.Index.substring(0, element.Index.length - 1));
                            const slot = document.createTextNode(element.Slot);
                            const start = document.createTextNode(element.Start);
                            const end = document.createTextNode(element.End);
                            const length = document.createTextNode(element.Length);
                            const description = document.createTextNode(element.Description);
                            // Add content to each row element
                            td_checkbox.appendChild(checkbox_element)
                            td_index.appendChild(index);
                            td_slot.appendChild(slot);
                            td_start.appendChild(start);
                            td_end.appendChild(end);
                            td_length.appendChild(length);
                            td_description.appendChild(description);
                            // Append row elements to this row
                            tr.appendChild(td_checkbox)
                            tr.appendChild(td_index);
                            tr.appendChild(td_slot);
                            tr.appendChild(td_start);
                            tr.appendChild(td_end);
                            tr.appendChild(td_length);
                            tr.appendChild(td_description);
                            // Add a new row to the table body
                            tbody.appendChild(tr)
                            
                        });
                        // Append the table body to the table
                        table.appendChild(tbody)
                        // Show the carving buttons
                        document.getElementById('combinedCarvingBtn').style.display = 'block'; 
                        document.getElementById('individualCarvingBtn').style.display = 'block';
                    } else {
                        // Handle cases where partition table information is not in the response, such as errors
                        console.error('MMLS info not found in response:', data);
                        document.getElementById('mmlsData').textContent = `Error: ${data.error} Details: ${data.details}`;
                    }
                })
                .catch(error => console.error('Error fetching MMLS data:', error));
        });

        document.getElementById('combinedCarvingBtn').addEventListener('click', function() {
            // Code adapted from https://stackoverflow.com/questions/23175006/how-to-check-multiple-checkboxes-with-javascript for checking whether checkboxes are checked, on April 7th 2024
            var checkboxes = document.getElementsByName('checkboxes'); // All checkboxes
            var checkboxes_selected_indices = []; // Stores the indices of the selected checkboxes
            var checkbox_index = 0;
            checkboxes.forEach(element => {
                if (element.checked == true) {
                    checkboxes_selected_indices.push(checkbox_index);
                }
                checkbox_index += 1;
            });

            // Prepare the API params:
            // Step 1: Check if the selected checkboxes are consecutive
            var consecutive = true;
            for (let i = 0; i < checkboxes_selected_indices.length - 1; i++){
                if (checkboxes_selected_indices[i + 1] - checkboxes_selected_indices[i] != 1){
                    consecutive = false
                }
            }
            
            if (consecutive){
                // Step 2: Determine the start sector
                var startSector = partitions[checkboxes_selected_indices[0]].Start
                // Step 3: Determine the carving length
                var carvingLength = 0
                checkboxes_selected_indices.forEach(element => {
                    // Code referenced https://www.geeksforgeeks.org/convert-a-string-to-an-integer-in-javascript/ for converting string to integers in JS, on April 7th 2024
                    carvingLength += Number(partitions[element].Length)
                });
                // Step 4: Determine the sector size
                var sectorSize = 512;

                // Call API for users to carve the partitions (COMBINED)
                fetch('/api/extract-data-to-download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        file_path: filePath,
                        start_sector: startSector,
                        length: carvingLength,
                        byte_size: sectorSize
                    })
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    // Specify the filename you want to download as
                    a.download = "Partitions.dd"; //should be dynamic based on user selection
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => console.error('Download error:', error));

            } else {
                // Code referenced https://www.w3schools.com/jsref/met_win_alert.asp for alerting a message to users, on April 7th 2024
                // Alert the users about the error: cannot do combined carving
                alert("Cannot carve together since the selected partitions are not consecutive");
            }
        });

        document.getElementById('individualCarvingBtn').addEventListener('click', function() {
            // Code adapted from https://stackoverflow.com/questions/23175006/how-to-check-multiple-checkboxes-with-javascript for checking whether checkboxes are checked, on April 7th 2024
            var checkboxes = document.getElementsByName('checkboxes'); // All checkboxes
            var checkboxes_selected_indices = []; // Stores the indices of the selected checkboxes
            var checkbox_index = 0;
            checkboxes.forEach(element => {
                if (element.checked == true) {
                    checkboxes_selected_indices.push(checkbox_index);
                }
                checkbox_index += 1;
            });

            // Prepare the API params: start sectors, lengths, sector size
            var startSectors = [];
            var carvingLengths = [];
            partitions[checkboxes_selected_indices[0]].Start;
            
            checkboxes_selected_indices.forEach(element => {
                startSectors.push(partitions[element].Start);
                carvingLengths.push(partitions[element].Length);
            });
            var sectorSize = 512;

            // Call API multiple times to carve the partitions (INDIVIDUALLY)
            for (let i = 0; i < checkboxes_selected_indices.length; i++){
                startSector = startSectors[i];
                carvingLength = carvingLengths[i];
                
                fetch('/api/extract-data-to-download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        file_path: filePath,
                        start_sector: startSector,
                        length: carvingLength,
                        byte_size: sectorSize
                    })
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    // Specify the filename you want to download as
                    download_filename = "Partition" + checkboxes_selected_indices[i] + ".dd"
                    a.download = download_filename; //should be dynamic based on user selection
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => console.error('Download error:', error));

            }

        });
    </script>
</body>
</html>
